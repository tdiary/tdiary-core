<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=EUC-JP">
	<meta name="Author" content="TADA Tadashi">
	<link rev="MADE" href="mailto:sho@spc.gr.jp">
	<link rel="INDEX" href="http://www.tdiary.net/">
	<meta http-equiv="content-style-type" content="text/css">
	<link rel="stylesheet" href="doc.css" type="text/css" media="all">
	<title>tDiary: How to make plugin</title>
</head>
<body>
<h1>tDiary<br><span style="font-size:medium">プラグインの作り方</span></h1>

<p><strong>※プラグインの使い方については、<a href="HOWTO-use-plugin.html">HOWTO-use-plugin.html</a>を参照してください。</strong></p>

<p>　プラグインはtDiary 1.3.1以降で使えるようになった、システムに機能を追加する仕組みです。プラグインは<a href="http://www.tdiary.net/">tDiary.Net</a>から入手することができます。また、tDiaryフルセットを利用している場合には、misc/pluginディレクトリに単独に配布されているのと同等のものが含まれています。これらの.rbファイルを、ファイルごとインストール先にあるpluginディレクトリに移動することで、利用できるようになります。</p>

<p>　プラグインにはさまざまなものがありますが、日記中に自動的に何かの文字列を埋め込んだり、特殊な処理をさせるのが主な目的です。また、特定のプラグインを作ることで、tDiaryのメッセージをカスタマイズすることもできます。</p>

<p>　以下では、プラグインについてその「作り方」を説明します。なお、.rbファイルのことを「プラグインファイル」、実際に日記中で呼び出して使う機能(主にRubyのメソッド)のことを「プラグイン」と呼びます。ひとつのプラグインファイルは、複数のプラグインを含みます。</p>

<h2><span class="title">プラグインの作り方</span></h2>
<p>　プラグインは、Rubyのメソッドになっています。これらのメソッドはプラグインを実装するPluginクラスのメソッドとして読み込まれ、日記ファイル生成時の最後の段階で呼び出されます。プラグインメソッドは文字列を返し、それがそのまま日記に埋め込まれることになります。</p>

<p>　制作側から見たプラグインには、だいたい3種類あるように見えます。ひとつは<a href="#custom">カスタマイズ系プラグイン</a>です。これらは日記の特定の場所にすでに埋め込まれていて、日記生成時に強制的に呼び出されます。デフォルトプラグインにおいてすでに定義されていて、同名のプラグインを再定義することで動作を変更することができるものです。各種メッセージや、日付・段落アンカー、HTMLヘッダを生成するプラグインがこれにあたります。</p>

<p>　2種類目のプラグインは、完全に<a href="#original">オリジナルのプラグイン</a>です。ヘッダやフッタ、日記本文に日記著者が意図的に記述することで呼び出されます。これらはデフォルトでは未定義で、既存のプラグインと名前がだぶらない限り好きな名称にできます。プラグイン集に収録されているプラグインは、たいていこれです。</p>

<p>　3種類目のプラグインは<a href="#callback">コールバック系プラグイン</a>です。これは呼び出される場所が決まっている点でカスタマイズ系プラグインに似ていますが、メソッドにはなっておらず、Procインスタンスを追加していく形で定義します。更新時だけに呼び出されるプラグインや、日記本文の前後に呼び出されるプラグイン、HTMLヘッダを追加するプラグインが定義できます。</p>

<p>　以降で、これらそれぞれのプラグインの作り方について説明します。</p>

<h3 class="subtitle"><a name="custom">カスタマイズ系プラグイン</a></h3>
<div class="section">
<p>　日記本文に現れるメッセージや文字列の多くは、プラグインによって差し込まれています。それぞれのメッセージに対応するプラグインを再定義することで、メッセージをカスタマイズできるのです。プラグイン作成のうちもっとも簡単なこのカスタマイズをこれから見ていきます。</p>
</div>

<div class="section">
<p>　カスタマイズ可能な文字列は、デフォルトプラグインとしてあらかじめ以下のように定義されています。</p>
</div>

<div class="section">
<pre>
def comment_today; '本日のツッコミ'; end
def comment_total( total ); "(全#{total}件)"; end
def comment_new; 'ツッコミを入れる'; end
def comment_description; 'ツッコミ・コメントがあればどうぞ! E-mailアドレスは公開されません。'; end
def comment_description_short; 'ツッコミ!!'; end
def comment_name_label; 'お名前'; end
def comment_name_label_short; '名前'; end
def comment_mail_label; 'E-mail'; end
def comment_mail_label_short; 'Mail'; end
def comment_body_label; 'コメント'; end
def comment_body_label_short; '本文'; end
def comment_submit_label; '投稿'; end
def comment_submit_label_short; '投稿'; end
def comment_date( time ); time.strftime( "(#{@date_format} %H:%M)" ); end
def referer_today; '本日のリンク元'; end
</pre>
</div>

<div class="section">
<p>　これらのメソッドを再定義することで、別の文字列を埋め込むことが可能です。</p>
</div>

<div class="section">
<p>　まず、自分のカスタマイズ用プラグインファイルを用意します。pluginディレクトリに、例えば「custom.rb」という名前でファイルを作ります。自分の日記の雰囲気には「ツッコミ」という言葉がしっくり来ないという場合を想定して、これらを書き換えることにしましょう。ツッコミという言葉を使っている4つのメソッドをcustom.rbにコピーして、「コメント」という言葉に置き換えます。</p>
</div>

<div class="section">
<pre>
def comment_today; '本日のコメント'; end
def comment_new; 'コメントを入れる'; end
def comment_description; 'コメントがあればどうぞ! E-mailアドレスは公開されません。'; end
def comment_description_short; 'コメント'; end
</pre>
</div>

<div class="section">
<p>　これだけでOKです。日記を表示して、変化していることを確認しましょう(スーパーリロードしないと変化しないかも知れません)。</p>
</div>

<div class="section">
<p>　他にも、カスタマイズ用プラグインとして「theme_url」が用意されています。</p>
</div>

<div class="section">
<pre>
def theme_url; 'theme'; end
</pre>
</div>

<div class="section">
<p>　このプラグインは、テーマファイルが置かれているURLを指定するものです。通常はインストール先のthemeディレクトリなのでこのままで大丈夫ですが、同一サーバで複数の日記を運用している場合など、テーマファイルを一か所に集めたい場合には、これを使わないとテーマが読み込まれません。</p>
</div>

<div class="section">
<p>　カスタマイズするときは、「'theme'」の代わりにテーマファイルのあるディレクトリのURLを指定します。URLの最後を「/」で終わってはいけません。</p>
</div>

<div class="section">
<p>　このほかにも、navi_userやnavi_adminを再定義することで、ナビゲーションボタンのラベルを変更することもできます。また00default.rbにはこれ以外にも、HTMLのヘッダの情報生成や、日付・段落アンカータグを生成する以下のようなプラグインが定義されています(詳しくはコードを読んでください)。</p>
</div>

<div class="section">
<ul>
<li><code>author_name</code>: 著者名を示すmetaタグを生成</li>
<li><code>author_mail</code>: 著者のメールアドレスを示すmetaタグを生成</li>
<li><code>index_page</code>: INDEXを示すmetaタグを生成</li>
<li><code>css_tag</code>: スタイルシートの利用を指示するタグを生成</li>
<li><code>title_tag</code>: titleタグを生成</li>
<li><code>anchor</code>: アンカータグを生成する</li>
</ul>
</div>

<h3 class="subtitle"><a name="original">オリジナルプラグインの実装</a></h3>
<div class="section">
<p>　以下では、Rubyのコードが書ける人を対象に、オリジナルのプラグインを実装する方法を解説します。と言っても、文字列を返すメソッドを書くだけなので難しいことはありません。ここでは、プラグイン内で利用できるインスタンス変数の解説だけ行います。</p>
</div>

<div class="section">
<p>　プラグインは専用のPluginクラスの内部で実行されるので、その中にある変数にしかアクセスできません。tDiaryの他の部分に影響が出ないようになっています。もっとも、evalを使って再定義してしまうことで、いくらでも自由になるのですが。</p>
</div>

<div class="section">
<p>　Pluginクラスのインスタンス変数には以下のものがあります。</p>
</div>

<div class="section">
<table border style="margin-left: 3em;">
<tr><th>@mode</th><td>現在動作中のモードを表現する文字列です。tdiary.rb中で使われているTDiaryクラスの策クラス名から、TDiaryを取って、downcaseしたものが含まれています。上手に利用するにはtDiaryの内部構造を知っている必要があるでしょう(いずれちゃんと説明書きます。すまぬ)</td></tr>
<tr><th>@diaries</th><td>日記データを保持するDiaryインスタンスのHashです。現在表示対象になっている日付を含む月全体が含まれます(最新表示で月をまたいでいる場合は、2ヶ月分含まれることがあります)。Hashのキーは「yyyymmdd」形式の日付で、Hashの値がDiaryインスタンスです。</td></tr>
<tr><th>@cgi</th><td>CGIクラスのインスタンスで、現在実行中のCGIに渡されてきたパラメタやCookieのデータが含まれています。スクリプトのパスや、パラメタの値を取得したい場合に利用できます。。</td></tr>
<tr><th>@years</th><td>現存するすべての日記の年月データを保持するHashです。キーは年、値は月のArrayです。</td></tr>
<tr><th>@cache_path</th><td>キャッシュファイルのあるディレクトリ。プラグインでキャッシュを使いたい場合は、ここに独自のディレクトリを掘って利用します。</td></tr>
<tr><th>@index</th><td>日記の本体を示すページのURLです。デフォルトは「./」。tdiary.confで指定した物と同じです。</td></tr>
<tr><th>@update</th><td>日記の更新ページを示すURLです。デフォルトは「update.rb」。tdiary.confで指定した物と同じです。</td></tr>
<tr><th>@author_name</th><td>日記著者(あなた)の名前です。tdiary.confで指定したものと同じです。</td></tr>
<tr><th>@author_mail</th><td>日記著者(あなた)のE-mailアドレスです。tdiary.confで指定したものと同じです。</td></tr>
<tr><th>@index_page</th><td>トップページのURLです。tdiary.confで指定したものと同じです。</td></tr>
<tr><th>@html_title</th><td>日記のタイトル。tdiary.confで指定したものと同じです。</td></tr>
<tr><th>@date</th><td>現在表示中の日付。特定の日か、月を表現したものかどうかは、@modeを見なければ判断できません。</td></tr>
<tr><th>@date_format</th><td>日付のフォーマットを示す文字列。tdiary.confで指定したものと同じです。</td></tr>
<tr><th>@referer_table</th><td>「本日のリンク元」で特定のURLを指定した文字列に変換するためのテーブル。Hashです。</td></tr>
</table>
</div>

<h3 class="subtitle"><a name="callback">コールバック系プラグイン</a></h3>
<div class="section">
<p>　上で説明した、単に文字列を返すメソッドを定義してそれを日記本文に埋め込んで使うだけのプラグインと違い、特定の状況でのみ呼び出されるようなコールバック系プラグインがあります。tDiaryの機能を拡張するために利用できます。以下にその作り方を解説します。</p>
</div>

<div class="section">
<p>　コールバック系のプラグインは現在、以下の4種類定義されています。</p>
</div>

<div class="section">
<ul>
	<li><code>update_proc</code>: 日記更新時およびツッコミ追加時に呼び出される</li>
	<li><code>header_proc</code>: HTMLヘッダ情報の生成時に呼び出される</li>
	<li><code>body_enter_proc</code>: 日記本文開始の直前で呼び出される。パラメタに処理中の日記の日付(Timeインスタンス)が与えられる</li>
	<li><code>body_leave_proc</code>: 日記本文終了の直後に呼び出される。パラメタに処理中の日記の日付(Timeインスタンス)が与えられる</li>
</ul>
</div>

<div class="section">
<p>　いずれも通常のプラグインと同様にメソッドとして実装されていますが、上書き定義してはいけません。上書きすると、この機能を使っている他のプラグインが呼び出されなくなってしまうためです。</p>
</div>

<div class="section">
<p>　このため、これらのプラグインには機能を追加するためのメソッド、<code>add_update_proc</code>と<code>add_header_proc</code>、<code>add_body_enter_proc</code>、<code>add_body_leave_proc</code>が用意されています。これらはProcインスタンスを引数に持ちます。ここで登録されたProcが順番に呼び出されることで、複数のプラグインが実行されます。これらのプラグインは以下のように定義して使います。</p>
</div>

<div class="section"><pre>
# 検索キーワードをheadに挿入する
add_header_proc( Proc::new do
   '&lt;meta name="keyword" content="Linux,Kondara"&gt;'
end )
</pre></div>

<div class="section">
<p>　なお、コールバック系プラグインはそれぞれのProcインスタンスが返した文字列をすべて連結してHTMLに埋め込みますが、<code>update_proc</code>は何も埋め込みません(意味がないので)。このため、<code>update</code>用に追加するProcは何も返す必要はありません。</p>
</div>

<div class="section">
<p>　デフォルトプラグインファイルである00default.rbには、標準のHTMLヘッダを生成するheader_proc用Procが定義されています。</p>
</div>

</body>
</html>
